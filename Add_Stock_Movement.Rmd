---
title: "Adding Stock movments"
author: "Mikkel Nymark Graugaard"
date: "23/3/2021"
output: html_document
---

Fetching and adding the stock movements 
```{r}
# getting the opening and closing prices of the stocks
library(BatchGetSymbols)


# set dates
first.date <- '2021-03-08' # Starting day
last.date <- '2021-03-22' # Ending day
freq.data <- 'daily' # Making sure it is daily opening and closing prices


l.out <- BatchGetSymbols(tickers = ticker, 
                         first.date = first.date,
                         last.date = last.date, 
                         freq.data = freq.data,
                         cache.folder = file.path(tempdir(), 
                                                  'BGS_Cache') ) # cache in tempdir()



# Calculating the stock movement per day 

price.list <- l.out[["df.tickers"]] # Extracting the list of prices
price.list$change <- price.list$price.close - price.list$price.open # Calculating the price change variable
price.list$movement <- ifelse(price.list$change>0, 1, 0) # Binary variable 1 stock went up, 0 stock didn't move or wen down
price.list <- price.list %>%
  mutate(day = wday(ref.date, label = TRUE, locale = "English_United States.1252"))
# Making sure that the tweets until the stock market opens will be used to predict the movement of the stocks for that day. 
```



Splitting the data frame for reddit in 2, in order to be compatible with the weekdays. 
e.g. monday is monday. 
```{r}
split_reddit <- split(clean1, clean1$created_utc<as.Date("2021-03-15 08:59:59"))
week1 <- split_reddit[["TRUE"]]
week2 <- split_reddit[["FALSE"]]
```



Splitting the data frame for stock movements in 2, in order to be compatible with the weekdays. 
e.g. monday is monday. 
```{r}
split_stocks <- split(price.list, price.list$ref.date<as.Date("2021-03-15"))
week1_stocks <- split_stocks[["TRUE"]]
week2_stocks <- split_stocks[["FALSE"]]
```



Adding the interesting variables from the stocks to the reddit stock list: Volume, change and movement
Joining the tables on date and ticker condition
Fisrt for week 1 and then week2
```{r}
week1_merge = merge(x=week1, y=week1_stocks[,c(5,7,8,12,13)], by.x=c("day", "ticker"), by.y=c("day", "ticker"),
              all.x = TRUE, all.y=FALSE, sort = TRUE)  

week2_merge = merge(x=week2, y=week2_stocks[,c(5,7,8,12,13)], by.x=c("day", "ticker"), by.y=c("day", "ticker"),
              all.x = TRUE, all.y=FALSE, sort = TRUE)  
```


```{r}
Tesla_clean <- rbind(week1_merge, week2_merge)
```



Saving as a CSV file ready for sentiment analysis
```{r}
write.csv(Tesla_clean,"~/R-data/Data Science Project/PredictStockusingRedditandTwitter/DataCleaning\\Reddit_Tesla_clean.csv", row.names = FALSE)
```


